<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Send Image</title>
    <script src="https://code.jquery.com/jquery-1.11.2.min.js"></script>
    <script src="https://cdn.dnky.co/sdk/2.0.0.0/dependencies/jquery.signalR-2.2.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.1.17/require.min.js"></script>
    <script src="../modules/require-config-debug.js"></script>
	<style type="text/css">
		body{
			font-family: 'Segoe UI';
			font-size: 12pt;
		}

		header h1{
			font-size:12pt;
			color: #fff;
			background-color: #1BA1E2;
			padding: 20px;

		}
		article
		{
			width: 80%;
			margin:auto;
			margin-top:10px;
		}


		.thumbnail{

			height: 100px;
			margin: 10px;    
		}	
	</style>
</head>
<body>

	<header>
        <h1>Send Image Demo</h1>
    </header>
    <article>
        <label for="files">Select multiple files: </label>
        <input id="files" type="file" multiple></input>
        <output id="result" />
    </article>
    <article>    
        <input id="users" type="text" />
        <button id="send">send</button>
    </article>


    <div id="logPanel"></div>
	<div id="imagePanel"></div>
	
	

    <script>
	
	function log(message) {
		$("#logPanel").append("<div>"+message+"</div>");
	}
	
	// Check File API support
    if(window.File && window.FileList && window.FileReader)
    {
        var filesInput = document.getElementById("files");
		
		var  picFile = null;
        
        filesInput.addEventListener("change", function(event){
            
            var files = event.target.files; // FileList object
            var output = document.getElementById("result");
            
            for(var i = 0; i< files.length; i++)
            {
                var file = files[i];
                
                // Only pics
                if(!file.type.match('image'))
                  continue;
                
                var picReader = new FileReader();
                
                picReader.addEventListener("load",function(event){
                    
                    picFile = event.target;
					                    
                    var div = document.createElement("div");
                    
                    div.innerHTML = "<img class='thumbnail' src='" + picFile.result + "'" + "title='" + picFile.name + "'/>";
                    
                    output.insertBefore(div,null);            
                
                });
                
                 //Read the image
                picReader.readAsDataURL(file);
            }                               
           
        });
    
	
        require(['donkyCore'],function(donkyCore) {

            // setup some Content Notification subscriptions ...
            donkyCore.subscribeToContentNotifications({
                name: "demoApp",
                version: "1.0.0.0",
            },
			{
				notificationType: "shareImage",
				handler: function(notification) {
				
					// log("<code>"+JSON.stringify(notification)+"</code>");
					
					var image = /*atob(*/notification.data.customData.base64Data/*)*/;
					
					$("#imagePanel").append("<img src='" + image + "'/>");				
				}
			});		
			
		
		
            donkyCore.initialise({
                apiKey: ">>Enter API Key <<",
                resultHandler: function(result) {

                    log("<code>"+JSON.stringify(result)+"</code>");

                    if(result.succeeded) {
                        var registrationDetails = donkyCore.donkyAccount.getRegistrationDetails();
                        log("<code>"+JSON.stringify(registrationDetails)+"</code>");
						
						$("#users").val(registrationDetails.userDetails.id);
						
						$("#send").click(function(){
							if(picFile !== null){
								
								var data = {
											"base64Data": /*btoa(*/picFile.result/*)*/
										};
										
								var users = $("#users").val().split(",");

								var notification = donkyCore.createContentNotificationForSpecifiedUsers(users,"shareImage",data);
								//log("<code>"+JSON.stringify(notification)+"</code>");
								donkyCore.sendContentNotifications(notification);							
							
							}
						});
						
						
						
                    }
                }
            });
        });
	
	
	}
    else
    {
        console.log("Your browser does not support File API");
    }

	
	
	

    </script>
</body>
</html>