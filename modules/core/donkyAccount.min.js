/*!
 * DonkyAccount JavaScript Library v1.0.0.0
 *
 * Copyright (C) Dynmark. All rights reserved.
 *
 */
;var DonkyAccount=(function(){var b,c=null;var d={tokenExpiryCheckInterval:10000};var a=null;function e(g){if(typeof b!="undefined"){return b}if(g===undefined||g===null){throw new Error("no options specified")}if(g.donkyCore===undefined){throw new Error("donkyCore not specified")}c=g.donkyCore;b=this;c.subscribeToLocalEvent("DonkyInitialised",function(h){if(a===null){a=setInterval(function(){b._checkToken(function(){})},d.tokenExpiryCheckInterval)}});return b}e.prototype._getBrowserInfo=function(){var h=navigator.userAgent,g,i=h.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];if(/trident/i.test(i[1])){g=/\brv[ :]+(\d+)/g.exec(h)||[];return"IE "+(g[1]||"")}if(i[1]==="Chrome"){g=h.match(/\bOPR\/(\d+)/);if(g!=null){return"Opera "+g[1]}}i=i[2]?[i[1],i[2]]:[navigator.appName,navigator.appVersion,"-?"];if((g=h.match(/version\/(\d+)/i))!=null){i.splice(1,1,g[1])}return i.join(" ")};e.prototype._isTokenExpired=function(){var l=c.donkyData.get("accessDetails");if(l!==null&&l!==undefined){var j=false;var h=new Date(l.expiresOn);var i=new Date();if(h>i){var g=Math.abs(i.getTime()-h.getTime());var k=Math.ceil(g/1000);if(k<60){j=true}}else{j=true}return j}else{return true}};e.prototype._checkToken=function(i,g){if((b.isRegistered()&&!b._isSuspended())||g===true){var h=b._isTokenExpired();if(h){this._refreshToken(i)}else{i({succeeded:true})}}else{i({succeeded:false})}};e.prototype._refreshToken=function(j){if(!c._isFunction(j)){throw new Error("resultHandler not supplied")}var i=false;var g=c.donkyNetwork._getSignalRState();switch(g){case c.donkyNetwork.signalrStatuses.initializing:case c.donkyNetwork.signalrStatuses.starting:case c.donkyNetwork.signalrStatuses.started:c.donkyNetwork._stopSignalR();i=true;break;default:break}var h={networkId:c.donkyData.get("networkId"),deviceSecret:c.donkyData.get("secret"),operatingSystem:"Web",sdkVersion:c.version()};c.donkyNetwork.ajax(h,"POST",c.donkyNetwork.api.anonymous,"authentication/gettoken",function(k){if(k.succeeded){c.donkyLogging.debugLog("Succesfully refreshed authorization token");c.donkyData.set("configuration",k.response.configuration);delete k.response.configuration;c.donkyData.set("accessDetails",k.response);c.donkyData.remove("isSuspended");if(i){c.donkyNetwork._startSignalR()}j({succeeded:true})}else{c.donkyLogging.warnLog("Failed to  refresh authorization token");if(k.statusCode===401){c.donkyLogging.warnLog("Can't refresh token - have I been deleted ?");var l=b.getRegistrationDetails();b._register(l,function(m){if(i){c.donkyNetwork._startSignalR()}j(m)})}else{if(k.statusCode===403){c.donkyLogging.warnLog("Can't refresh token - have been suspended");c.donkyData.set("isSuspended",true)}}if(k.statusCode!==401){j({succeeded:false,result:k})}}})};e.prototype._getDeviceId=function(){var g=c.donkyData.get("deviceId");if(g===null){g=c._uuid();c.donkyData.set("deviceId",g);c.donkyData.set("secret",c._uuid())}return g};e.prototype.isRegistered=function(){try{return c.donkyData.get("networkId")!==null}catch(g){c.donkyLogging.errorLog("caught exception in isRegistered() : "+g);return false}};function f(h){var g={id:b._getDeviceId(),secret:c.donkyData.get("secret"),operatingSystem:"Web",operatingSystemVersion:navigator.userAgent,model:b._getBrowserInfo()};return c._extend(h,g)}e.prototype._register=function(g,i){if(!c._isFunction(i)){throw new Error("resultHandler not supplied")}if(g.deviceDetails===undefined){g.deviceDetails={}}var h={device:g.deviceDetails,user:g.userDetails,client:{sdkVersion:c.version(),moduleVersions:c._moduleVersions,appVersion:g.appVersion,currentLocalTime:new Date().toISOString()}};f(h.device);c.donkyLogging.debugLog(JSON.stringify(h));c.donkyNetwork.ajax(h,"POST",c.donkyNetwork.api.anonymous,"registration",function(k){if(k.succeeded){c.donkyData.set("networkId",k.response.networkId);c.donkyData.set("configuration",k.response.accessDetails.configuration);delete k.response.accessDetails.configuration;c.donkyData.set("accessDetails",k.response.accessDetails);var j=h.user!==undefined?h.user:{id:k.response.userId};j.isAnonymous=h.user===undefined;if(j.displayName===undefined){j.displayName=k.response.userId}delete h.device.id;delete h.device.secret;c.donkyData.set("userDetails",j);c.donkyData.set("deviceDetails",h.device);c.donkyData.set("clientDetails",h.client);c.publishLocalEvent({type:"RegistrationChanged",data:{userDetails:j,deviceDetails:h.device}})}i(k)})};e.prototype.getRegistrationDetails=function(){try{return{userDetails:c.donkyData.get("userDetails"),deviceDetails:c.donkyData.get("deviceDetails")}}catch(g){c.donkyLogging.errorLog("caught exception in getRegistrationDetails() : "+g);return null}};e.prototype.getDevice=function(){try{var g=c.donkyData.get("deviceDetails");if(g==null){g={operatingSystem:"Web",operatingSystemVersion:navigator.userAgent,model:b._getBrowserInfo()}}return g}catch(h){c.donkyLogging.errorLog("caught exception in getDevice() : "+h);return null}};e.prototype._getClient=function(){return c.donkyData.get("clientDetails")};e.prototype.updateRegistrationDetails=function(h,g){try{if(!c._isFunction(g)){throw new Error("callback not supplied")}if(h===undefined||h===null){throw new Error("settings not supplied")}if(h.userDetails!==undefined&&h.deviceDetails!==undefined){b._updateRegistrationDetails(h,g)}else{if(h.userDetails!==undefined){b.updateUserDetails(h.userDetails,g)}else{if(h.deviceDetails!==undefined){b.updateDeviceDetails(h.deviceDetails,g)}else{throw new Error("neither userDetails or deviceDetails specified - must specify at least 1")}}}}catch(i){c.donkyLogging.errorLog("caught exception in updateRegistrationDetails() : "+i)}};e.prototype.replaceRegistration=function(h,g){try{c.donkyNetwork.synchronise(function(){b._register(h,function(j){g(j)})})}catch(i){c.donkyLogging.errorLog("caught exception in replaceRegistration() : "+i)}};e.prototype._updateRegistrationDetails=function(h,i){var g={user:h.userDetails,device:h.deviceDetails};f(g.device);c.donkyNetwork.ajax(g,"PUT",c.donkyNetwork.api.secure,"registration",function(j){if(j.succeeded){c.donkyData.set("userDetails",g.user);delete g.device.id;delete g.device.secret;c.donkyData.set("deviceDetails",g.device)}i(j)})};e.prototype.updateUserDetails=function(i,h){try{if(i===undefined){throw new Error("userDetails not supplied")}if(!c._isFunction(h)){throw new Error("callback not supplied")}c.donkyNetwork.ajax(i,"PUT",c.donkyNetwork.api.secure,"registration/user",function(j){if(j.succeeded){c.donkyData.set("userDetails",i)}h(j)})}catch(g){c.donkyLogging.errorLog("caught exception in updateUserDetails() : "+g)}};e.prototype.updateDeviceDetails=function(g,i){try{if(g===undefined){throw new Error("deviceDetails not supplied")}if(!c._isFunction(i)){throw new Error("callback not supplied")}f(g);c.donkyNetwork.ajax(g,"PUT",c.donkyNetwork.api.secure,"registration/device",function(j){if(j.succeeded){delete g.id;delete g.secret;c.donkyData.set("deviceDetails",g)}i(j)})}catch(h){c.donkyLogging.errorLog("caught exception in updateDeviceDetails() : "+h)}};e.prototype._updateClient=function(g,i){try{if(!c._isFunction(i)){throw new Error("callback not supplied")}c.donkyNetwork.ajax(g,"PUT",c.donkyNetwork.api.secure,"registration/client",function(j){if(j.succeeded){c.donkyData.set("clientDetails",g)}i(j)})}catch(h){c.donkyLogging.errorLog("caught exception in _updateClient() : "+h)}};e.prototype._isSuspended=function(){var g=c.donkyData.get("isSuspended");return g!==null?g:false};e.prototype.getTags=function(h){try{if(!c._isFunction(h)){throw new Error("callback not supplied")}c.donkyNetwork.ajax(null,"GET",c.donkyNetwork.api.secure,"registration/user/tags",function(i){h(i)})}catch(g){c.donkyLogging.errorLog("caught exception in getTags() : "+g)}};e.prototype.putTags=function(g,i){try{if(!c._isFunction(i)){throw new Error("callback not supplied")}c.donkyNetwork.ajax(g,"PUT",c.donkyNetwork.api.secure,"registration/user/tags",function(j){i(j)})}catch(h){c.donkyLogging.errorLog("caught exception in putTags() : "+h)}};return e})();