/*!
 * DonkyRichPopupUI JavaScript Library
 *
 * Copyright (C) Donky Networks Ltd. All rights reserved.
 *
 */
(function(){var a=function(h,d,b,g,e){if(h===undefined){throw new Error("Missing donkyCore")}if(d===undefined){throw new Error("Missing donkyRichLogic")}if(b===undefined){throw new Error("Missing donkyUICommon")}if(g===undefined){throw new Error("Missing donkyMessagingCommon")}if(e===undefined){throw new Error("Missing Mustache")}var i;var c={popupCSSURL:"../css/DonkyRichPopup.css",popupCSS:null,templateURL:"../templates/RichPopupTemplate.html",template:null,animationDirection:"bottom",animationSpeed:1000,bootstrapCssUrl:"https://netdna.bootstrapcdn.com/bootstrap/3.1.0/css/bootstrap.min.css",jqueryJsUrl:"https://code.jquery.com/jquery-2.1.1.min.js",iframeCssUrl:"../css/DonkyRichPopupIframe.css",iframeId:"donkyRichPopupIframe",deleteOnClose:true};var j={displayingPopup:false,isDisplayingRichPopup:function(){return this.displayingPopup},remove:function(){var l=$("#"+c.iframeId);var k=this;l.fadeOut("fast",function(){l.remove();k.displayingPopup=false;k.renderNextUnreadRichPopup(true)})},renderNextUnreadRichPopup:function(){var k=d.getNextUnreadRichMessage();if(k!=null){this.renderRichPopup(k)}},_renderRichPopup:function(n,p,m){var o=e.to_html(p,m);var k="";if(c.popupCSSURL!==null&&c.popupCSSURL!==undefined){k+="<link href='"+c.popupCSSURL+"' rel='stylesheet'>"}if(c.popupCSS!==null&&c.popupCSS!==undefined){k+="<style type='text/css'>"+c.popupCSS+"</style>"}var l="<!DOCTYPE html>                        <html lang='en'>                         <head>                        <meta charset='utf-8' />                        <meta http-equiv='X-UA-Compatible' content='IE=edge'/>                        <meta name='viewport' content='width=device-width, initial-scale=1' />                        <title>Donky Rich Message</title>                        <link href='"+c.bootstrapCssUrl+"'  rel='stylesheet' type='text/css'  />                        <script src='"+c.jqueryJsUrl+"' type='text/javascript'><\/script>"+k+"</head>                        <body><div id='pushMessageContainer' style='position:absolute;width: 100%;'>"+o+"</div></body>                        <script>                            $(function(){                                $('.popupClose').click(function(){                                    window.parent.$(window.parent.document).trigger('DonkyRichPopupClosed', [$(this).data('message-id'), $(this).text()]);                                });                            });                        <\/script>                        </html>";$("body").append("<iframe id='"+c.iframeId+"' seamless='seamless' frameborder='0' scrolling='no' ></iframe>");b.renderIframeSrcDoc($("#"+c.iframeId),l,function(q){b.renderIframeSrcDoc(q.contents().find("#RichMessage"),m.Body)})},renderRichPopup:function(o){this.displayingPopup=true;h.donkyLogging.infoLog("rendering this: "+JSON.stringify(o));var k=d.getMessageCount();var l=k.unreadRichMessageCount-1;if(l==0){l=""}var n={AvatarUrl:o.avatarAssetId!=null?h.formatAssetUrl(o.avatarAssetId):"",MessageId:o.messageId,SenderDisplayName:o.senderDisplayName,Body:!g.isExpired(o.expiryTimestamp)?o.body:o.expiredBody,UnreadCount:l,ResponsiveStyle:document.body.clientWidth<768?"forMobile":"forDesktop",CloseButton:"<span class='glyphicon glyphicon-remove popupClose' data-message-id='"+o.messageId+"'></span>"};if(c.template!==null){this._renderRichPopup(o.messageId,c.template,n)}else{var m=this;$.get(c.templateURL,function(p){c.template=p;m._renderRichPopup(o.messageId,c.template,n)})}}};function f(){}f.prototype={initialise:function(k){h._extend(c,k);b.loadCss(c.iframeCssUrl);j.renderNextUnreadRichPopup();h.subscribeToLocalEvent("NewRichMessagesReceived",function(m){h.donkyLogging.infoLog("NewRichMessagesReceived");if(!j.isDisplayingRichPopup()){j.renderNextUnreadRichPopup()}else{var l=d.getMessageCount();$("#"+c.iframeId).contents().find(".badge").text(l.unreadRichMessageCount)}});$(document).on("DonkyRichPopupClosed",function(l,m){h.donkyLogging.infoLog("DonkyRichPopupClosed: "+m);d.markRichMessageRead(m);if(c.deleteOnClose){d.deleteRichMessage(m)}j.remove()})}};i=new f();return i};if(typeof define==="function"&&define.amd){define("donkyRichPopupUI",["donkyCore","donkyRichLogic","donkyUICommon","donkyMessagingCommon","Mustache"],function(d,c,e,b,f){return a(d,c,e,b,f)})}else{window.donkyRichPopupUI=a(window.donkyCore,window.donkyRichLogic,window.donkyUICommon,window.donkyMessagingCommon,window.Mustache)}}());