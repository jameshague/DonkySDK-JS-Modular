/*!
 * DonkyRichLogic JavaScript Library
 *
 * Copyright (C) Donky Networks Ltd. All rights reserved.
 *
 */
(function(){var a=function(d,c){if(d===undefined){throw new Error("Missing donkyCore")}if(c===undefined){throw new Error("Missing donkyMessagingCommon")}var b;var f={richMessageAvailabilityDays:30};var g={load:function(){var i=d.donkyData.get("richMessages");if(i==null){i=[]}return i},save:function(i){d.donkyData.set("richMessages",i)},add:function(k){var i=this.load();d.donkyLogging.debugLog("_richMessageManager.add("+JSON.stringify(k)+") : currentMessageCount = "+i.length);var j=this.findId(i,k.messageId);if(j==-1){i.push(k);this.save(i);return true}else{d.donkyLogging.warnLog("Already got this rich Message: "+k.messageId);return false}},remove:function(k){d.donkyLogging.debugLog("_richMessageManager.remove("+k+")");var i=this.load();var j=this.findId(i,k);if(j!==-1){d.donkyLogging.debugLog("Removing ... "+i.length);i.splice(j,1);d.donkyLogging.debugLog("Removed ..."+i.length);this.save(i)}else{d.donkyLogging.warnLog("Failed to find rich Message")}},findObj:function(j){var i=this.load();var k=null;$.each(i,function(l,m){if(m.messageId==j){k=m}return k===null});return k},findId:function(i,j){var k=-1;$.each(i,function(l,m){if(m.messageId==j){k=l;d.donkyLogging.infoLog("Found message in position "+l)}return k==-1});return k},markAsRead:function(k){var i=this.load();var j=this.findId(i,k);if(j!==-1){i[j].isRead=true;this.save(i)}},getNextUnread:function(){var j=this.load();if(j.length>0){for(var k=0;k<j.length;k++){if(!j[k].isRead){return j[k]}}return null}else{return null}},isExpired:function(l){var k=false;if(c.isExpired(l.expiryTimestamp)&&l.expiredBody===null){k=true}else{var j=new Date(l.sentTimestamp);var i=new Date();var m=d._dateDiff(j,i);if(m!==NaN){if(m.days>f.richMessageAvailabilityDays){k=true}}}return k},removeExpiredMessages:function(){var j=this.load();var l=0;for(var k=j.length-1;k>=0;k--){if(this.isExpired(j[k])){d.donkyLogging.infoLog("messageId "+j[k].messageId+" is expired, deleting");j.splice(k,1);l++}}if(l>0){this.save(j)}}};function h(k){var j=k.data;j.serverNotificationId=k.id;j.isRead=false;j.receevedTimestamp=new Date().toISOString();var i=g.isExpired(j);if(!i){if(g.add(j)){d.publishLocalEvent({type:"NewRichMessagesReceived",data:{}})}}c.markMessageReceived(k,i)}function e(){var i=d.donkyData.get("configuration");if(i!==null&&i!==undefined&&i.configurationItems!==undefined){if(typeof i.configurationItems.richMessageAvailabilityDays=="string"){f.richMessageAvailabilityDays=parseInt(i.configurationItems.richMessageAvailabilityDays)}}g.removeExpiredMessages();d.subscribeToDonkyNotifications({name:"DonkyRichLogic",version:"2.0.0.0"},{notificationType:"RichMessage",handler:h},false)}e.prototype={getMessageCount:function(){try{var i=g.load();var j=0;$.each(i,function(l,m){if(m.isRead==false){j++}});return{richMessageCount:i.length,unreadRichMessageCount:j}}catch(k){d.donkyLogging.errorLog("caught exception in getMessageCounts() : "+k)}return null},deleteRichMessage:function(i){try{d.donkyLogging.debugLog("DonkyRichLogic.deleteConversation("+i+")");g.remove(i)}catch(j){d.donkyLogging.errorLog("caught exception in deleteRichMessage() : "+j)}},filterRichMessages:function(l){try{var j=g.load();var i=new Array();$.each(j,function(m,n){if(n.description.indexOf(l)!=-1){i.push(n)}});return i}catch(k){d.donkyLogging.errorLog("caught exception in filterChatConversations() : "+k);return null}},getAllRichMessages:function(){try{return g.load()}catch(i){d.donkyLogging.errorLog("caught exception in getAllRichMessages() : "+i)}return null},markRichMessageRead:function(i){try{var j=g.findObj(i);if(j!==null&&!j.isRead){c.markMessageRead(j);g.markAsRead(j.messageId)}}catch(k){d.donkyLogging.errorLog("caught exception in markChatMessageRead() : "+k)}},getNextUnreadRichMessage:function(){try{return g.getNextUnread()}catch(i){d.donkyLogging.errorLog("caught exception in getNextRichMessage() : "+i)}return null}};b=new e();return b};if(typeof define==="function"&&define.amd){define("donkyRichLogic",["donkyCore","donkyMessagingCommon"],function(c,b){return a(c,b)})}else{window.donkyRichLogic=a(window.donkyCore,window.donkyMessagingCommon)}}());