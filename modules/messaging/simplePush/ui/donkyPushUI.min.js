/*!
 * donkyPushUI JavaScript Library
 *
 * Copyright (C) Donky Networks Ltd. All rights reserved.
 *
 */
(function(){var a=function(d,b,e,h){if(d===undefined){throw new Error("Missing donkyCore")}if(b===undefined){throw new Error("Missing donkyPushLogic")}if(e===undefined){throw new Error("Missing donkyUICommon")}if(h===undefined){throw new Error("Missing Mustache")}var c;var i={bannerCSSURL:"../css/DonkyNotification.css",bannerCSS:null,templateURL:"../templates/SimplePushTemplate.html",template:null,animationDirection:"bottom",animationSpeed:1000,bootstrapCssUrl:"https://netdna.bootstrapcdn.com/bootstrap/3.1.0/css/bootstrap.min.css",jqueryJsUrl:"https://code.jquery.com/jquery-2.1.1.min.js",iframeCssUrl:"../css/DonkyNotificationIframe.css",iframeId:"donkySimplePushIframe",defaultAvatar:"../images/NoImage.png"};var g={displayingBanner:false,isDisplayingBanner:function(){return this.displayingBanner},remove:function(){var k=$("#"+i.iframeId);var j=this;k.fadeOut("fast",function(){k.remove();j.displayingBanner=false;j.renderNextBanner(true)})},renderNextBanner:function(k){var j=b.getNextSimplePush();if(j!=null){this.renderPushMessage(j,k)}},getButtons:function(n){var m=n.data;var l=[];if($.isArray(m.buttonSets)&&m.buttonSets.length>0){$.each(m.buttonSets,function(o,p){if(p.platform=="Web"){$.each(p.buttonSetActions,function(q,s){var r={buttonText:s.label};switch(s.actionType){case"Dismiss":r.className="bannerDismiss";break;default:r.className="bannerAction";if(s.data!=null){r.linkURL=s.data}break}l.push(r)})}})}var j="";var k="";$.each(l,function(o,p){if(p.linkURL!==undefined){if(p.linkURL.indexOf("http")==0){k="target='_blank' data-url='' href='"+p.linkURL+"' data-notification-id='"+n.id+"'";j="<a class='btn "+p.className+"'"+k+">"+p.buttonText+"</a>"}else{k="data-url='"+p.linkURL+"' data-notification-id='"+n.id+"'";j="<a class='btn "+p.className+"'"+k+">"+p.buttonText+"</a>"}}else{k="data-notification-id='"+n.id+"'";j="<a class='btn "+p.className+"'"+k+">"+p.buttonText+"</a>"}p.ButtonHtml=j;p.ButtonAttributes=k});return l},_renderPushMessage:function(o,m,k){var n=h.to_html(o,m);var p="";if(k){switch(i.animationDirection){case"top":p="$container.css('top','-'+$container.outerHeight(true)+'px').animate({top : '0'}, "+i.animationSpeed+");";break;case"right":p="$container.css('right','-'+$container.outerWidth(true)+'px').animate({right : '0'}, "+i.animationSpeed+");";break;case"bottom":p="$container.css('bottom','-'+$container.outerHeight(true)+'px').animate({bottom : '0'}, "+i.animationSpeed+");";break;case"left":p="$container.css('left','-'+$container.outerWidth(true)+'px').animate({left : '0'}, "+i.animationSpeed+");";break}}var j="";if(i.bannerCSSURL!==null&&i.bannerCSSURL!==undefined){j+="<link href='"+i.bannerCSSURL+"' rel='stylesheet'>"}if(i.bannerCSS!==null&&i.bannerCSS!==undefined){j+="<style type='text/css'>"+i.bannerCSS+"</style>"}var l="<!DOCTYPE html>                        <html lang='en'>                         <head>                        <meta charset='utf-8' />                        <meta http-equiv='X-UA-Compatible' content='IE=edge'/>                        <meta name='viewport' content='width=device-width, initial-scale=1' />                        <title>Donky Rich Message</title>                        <link href='"+i.bootstrapCssUrl+"'  rel='stylesheet' type='text/css'  />                        <script src='"+i.jqueryJsUrl+"' type='text/javascript'><\/script>"+j+"</head>                        <body><div id='pushMessageContainer' style='position:absolute;width: 100%;'>"+n+"</div></body>                        <script>                            $(function(){                                var $container = $('#pushMessageContainer');var outerHeight = $container.outerHeight(true);                                $('#"+i.iframeId+"', window.parent.document).height(outerHeight + 'px');                                "+p+"                                $('.bannerAction').click(function(){                                    window.parent.$(window.parent.document).trigger('DonkyBannerClicked', [$(this).data('notification-id'), $(this).text(), $(this).data('url')]);                                });                                $('.bannerDismiss, .bannerClose').click(function(){                                    window.parent.$(window.parent.document).trigger('DonkyBannerDismissed', [$(this).data('notification-id'), $(this).text()]);                                });                            });                        <\/script>                        </html>";$("body").append("<iframe id='"+i.iframeId+"' frameborder='0' scrolling='no' ></iframe>");e.renderIframeSrcDoc($("#"+i.iframeId),l)},renderPushMessage:function(o,k){this.displayingBanner=true;d.donkyLogging.infoLog("rendering this: "+JSON.stringify(o));var n=o.data;var m=b.getMessageCount();var p=m-1;var l={AvatarUrl:n.avatarAssetId!=null?d.formatAssetUrl(n.avatarAssetId):i.defaultAvatar,NotificationId:o.id,SenderDisplayName:n.senderDisplayName,Body:n.body,Buttons:this.getButtons(o),UnreadCount:p>0?p:"",ResponsiveStyle:document.body.clientWidth<768?"forMobile":"forDesktop",CloseButton:"<span class='glyphicon glyphicon-remove bannerClose' data-notification-id='"+o.id+"'></span>"};if(i.template!==null){this._renderPushMessage(i.template,l,k)}else{var j=this;$.get(i.templateURL,function(q){i.template=q;j._renderPushMessage(i.template,l,k)})}}};function f(){console.log("Constructing DonkyPushUI")}f.prototype={initialise:function(j){d._extend(i,j);e.loadCss(i.iframeCssUrl);g.renderNextBanner(false);d.subscribeToLocalEvent("NewSimplePushMessagesReceived",function(m){d.donkyLogging.infoLog("NewSimplePushMessagesReceived");if(!g.isDisplayingBanner()){g.renderNextBanner(true)}else{var l=b.getMessageCount();var k=l-1;$("#donkySimplePushIframe").contents().find(".badge").text(k)}});$(document).on("DonkyBannerClicked",function(k,n,m,l){d.donkyLogging.infoLog("DonkyBannerClicked: "+n);b.setSimplePushResult(n,m);if(l!=""){location.href=l}else{g.remove()}});$(document).on("DonkyBannerDismissed",function(k,m,l){d.donkyLogging.infoLog("DonkyBannerDismissed: "+m);b.setSimplePushResult(m,l);g.remove()})}};c=new f();return c};if(typeof define==="function"&&define.amd){define("donkyPushUI",["donkyCore","donkyPushLogic","donkyUICommon","Mustache"],function(c,b,d,e){return a(c,b,d,e)})}else{window.donkyPushUI=a(window.donkyCore,window.donkyPushLogic,window.donkyUICommon,window.Mustache)}}());