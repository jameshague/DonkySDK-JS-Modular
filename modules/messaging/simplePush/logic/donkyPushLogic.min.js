/*!
 * DonkyPushLogic JavaScript Library
 *
 * Copyright (C) Donky Networks Ltd. All rights reserved.
 *
 */
(function(){var a=function(d,c){if(d===undefined){throw new Error("Missing donkyCore")}if(c===undefined){throw new Error("Missing donkyMessagingCommon")}var b;var g={load:function(){var h=d.donkyData.get("pushMessages");if(h==null){h=[]}return h},save:function(h){d.donkyData.set("pushMessages",h)},add:function(i){var h=this.load();d.donkyLogging.debugLog("_pushMessageManager.add("+JSON.stringify(i)+") : currentMessageCount = "+h.length);var j=this.findId(h,i.id);if(j==-1){h.push(i);this.save(h);return true}else{d.donkyLogging.warnLog("Already got this push Message: "+i.id);return false}},remove:function(j){d.donkyLogging.debugLog("_pushMessageManager.remove("+j+")");var h=this.load();var i=this.findId(h,j);if(i!==-1){d.donkyLogging.debugLog("Removing ... "+h.length);h.splice(i,1);d.donkyLogging.debugLog("Removed ..."+h.length);this.save(h)}else{d.donkyLogging.warnLog("Failed to find push Message")}},findObj:function(j){var h=this.load();var i=null;$.each(h,function(k,l){if(l.id==j){i=l}return i===null});return i},findId:function(h,j){var i=-1;$.each(h,function(k,l){if(l.id==j){i=k;d.donkyLogging.infoLog("Found message in position "+k)}return i==-1});return i},getNext:function(){var h=this.load();if(h.length>0){var i=h[0];if(i.displayed===undefined){i.displayed=new Date().valueOf();this.save(h)}return i}else{return null}},removeExpiredMessages:function(){var h=this.load();var k=0;for(var j=h.length-1;j>=0;j--){if(c.isExpired(h[j].data.expiryTimeStamp)){d.donkyLogging.infoLog("messageId "+h[j].data.messageId+" is expired, deleting");h.splice(j,1);k++}}if(k>0){this.save(h)}}};function f(i){var h=c.isExpired(i.data.expiryTimestamp);if(!h){if(g.add(i)){d.publishLocalEvent({type:"NewSimplePushMessagesReceived",data:{}})}}else{d.donkyLogging.debugLog("Received expired message, binning off ...")}c.markMessageReceived(i,h)}function e(){g.removeExpiredMessages();d.subscribeToDonkyNotifications({name:"DonkyPushLogic",version:"2.0.0.0"},{notificationType:"SimplePushMessage",handler:f},false)}e.prototype={getNextSimplePush:function(){try{return g.getNext()}catch(h){d.donkyLogging.errorLog("caught exception in getNextSimplePush() : "+h)}return null},setSimplePushResult:function(i,p){var k=g.findObj(i);if(k!=null){g.remove(i);var j=k.data;if(p!=""){var n={};$.each(j.buttonSets,function(t,u){if(u.platform=="Web"){n=u}});var m="";var r="Button1";switch(n.interactionType){case"OneButton":m=n.buttonSetActions[0].label;break;case"TwoButton":m=n.buttonSetActions[0].label+"|"+n.buttonSetActions[1].label;if(p==n.buttonSetActions[1].label){r="Button2"}break}var s=new Date(k.displayed);var h=new Date();var o=h.getTime()-s.getTime();var l=Math.floor(o/1000);var q={type:"InteractionResult",senderInternalUserId:j.senderInternalUserId,messageId:j.messageId,senderMessageId:j.senderMessageId,timeToInteractionSeconds:l,interactionTimestamp:new Date().toISOString(),interactionType:n.interactionType,buttonDescription:m,userAction:r,operatingSystem:"Web",messageSentTimestamp:j.msgSentTimeStamp,contextItems:j.contextItems};d.queueClientNotifications(q)}}else{d.donkyLogging.warnLog("setSimplePushResult("+i+", "+p+") - Coundn't find message in store")}},getMessageCount:function(){try{var h=g.load();return h.length}catch(i){d.donkyLogging.errorLog("caught exception in getMessageCounts() : "+i)}return null}};b=new e();return b};if(typeof define==="function"&&define.amd){define("donkyPushLogic",["donkyCore","donkyMessagingCommon"],function(c,b){return a(c,b)})}else{window.donkyPushLogic=a(window.donkyCore,window.donkyMessagingCommon)}}());